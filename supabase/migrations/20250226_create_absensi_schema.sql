-- Tabel Data Karyawan Pabrik
CREATE TABLE IF NOT EXISTS public.karyawan_pabrik (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nama TEXT NOT NULL,
    kode_karyawan TEXT NOT NULL UNIQUE,
    jabatan TEXT,
    tanggal_masuk DATE DEFAULT CURRENT_DATE,
    status_aktif BOOLEAN DEFAULT true,
    gaji_pokok NUMERIC DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabel Absensi Harian
CREATE TABLE IF NOT EXISTS public.absensi_pabrik (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    karyawan_id BIGINT REFERENCES public.karyawan_pabrik(id) ON DELETE CASCADE,
    tanggal DATE NOT NULL,
    status_kehadiran TEXT NOT NULL, -- 'Hadir', 'Sakit', 'Izin', 'Alpha', 'Libur'
    jam_masuk TIME,
    jam_keluar TIME,
    keterangan TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(karyawan_id, tanggal) -- Mencegah duplikasi absen per orang per hari
);

-- Enable RLS
ALTER TABLE public.karyawan_pabrik ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.absensi_pabrik ENABLE ROW LEVEL SECURITY;

-- Policies (Public Access for simplicity in this context)
CREATE POLICY "Public Access Karyawan" ON public.karyawan_pabrik FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Public Access Absensi" ON public.absensi_pabrik FOR ALL USING (true) WITH CHECK (true);

-- Grant Permissions
GRANT ALL ON public.karyawan_pabrik TO anon, authenticated, service_role;
GRANT ALL ON public.absensi_pabrik TO anon, authenticated, service_role;

-- Insert Dummy Data Karyawan (Optional)
INSERT INTO public.karyawan_pabrik (nama, kode_karyawan, jabatan) VALUES
('Asep Supriatna', 'PAB-001', 'Operator Jahit'),
('Budi Santoso', 'PAB-002', 'Operator Potong'),
('Siti Aminah', 'PAB-003', 'Quality Control'),
('Dedi Mulyadi', 'PAB-004', 'Helper')
ON CONFLICT (kode_karyawan) DO NOTHING;
