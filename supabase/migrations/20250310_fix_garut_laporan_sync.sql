-- FUNGSI SINKRONISASI LAPORAN BULANAN GARUT
-- Menyalin data dari total_gaji_pabrik_garut ke laporan_bulanan_pabrik_garut
-- Hanya menyalin data Non-Borongan

-- 1. Pastikan Tabel Laporan Ada & Strukturnya Sesuai
CREATE TABLE IF NOT EXISTS public.laporan_bulanan_pabrik_garut (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    bulan TEXT,
    periode TEXT,
    kode TEXT,
    nama TEXT,
    perusahaan TEXT,
    bagian TEXT,
    divisi TEXT,
    grade TEXT,
    grade_p1 TEXT,
    grade_p2 TEXT,
    h NUMERIC DEFAULT 0,
    b NUMERIC DEFAULT 0,
    i_b NUMERIC DEFAULT 0,
    i_tb NUMERIC DEFAULT 0,
    s_b NUMERIC DEFAULT 0,
    s_tb NUMERIC DEFAULT 0,
    t_b NUMERIC DEFAULT 0,
    t_tb NUMERIC DEFAULT 0,
    set_h NUMERIC DEFAULT 0,
    lp NUMERIC DEFAULT 0,
    tm NUMERIC DEFAULT 0,
    lembur NUMERIC DEFAULT 0,
    gapok NUMERIC DEFAULT 0,
    gaji_lembur NUMERIC DEFAULT 0,
    u_m NUMERIC DEFAULT 0,
    u_k NUMERIC DEFAULT 0,
    uang_bonus NUMERIC DEFAULT 0,
    kasbon NUMERIC DEFAULT 0,
    penyesuaian_bonus NUMERIC DEFAULT 0,
    hasil_gaji NUMERIC DEFAULT 0,
    keterangan TEXT,
    keluar_masuk TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index agar performa cepat
CREATE INDEX IF NOT EXISTS idx_laporan_garut_bulan ON public.laporan_bulanan_pabrik_garut(bulan);
CREATE INDEX IF NOT EXISTS idx_laporan_garut_kode ON public.laporan_bulanan_pabrik_garut(kode);

-- 2. Fungsi Sync
CREATE OR REPLACE FUNCTION sync_garut_laporan_bulanan(p_bulan TEXT)
RETURNS VOID AS $$
BEGIN
    -- A. Hapus data lama di laporan bulanan untuk bulan ini
    DELETE FROM public.laporan_bulanan_pabrik_garut WHERE bulan = p_bulan;

    -- B. Salin data dari total_gaji_pabrik_garut
    -- Filter: EXCLUDE yang mengandung kata 'BORONGAN' di Perusahaan, Bagian, atau Divisi
    INSERT INTO public.laporan_bulanan_pabrik_garut (
        bulan, periode, kode, nama, perusahaan, bagian, divisi,
        grade, grade_p1, grade_p2,
        h, b, i_b, i_tb, s_b, s_tb, t_b, t_tb, set_h, lp, tm, lembur,
        gapok, gaji_lembur, u_m, u_k, uang_bonus, kasbon, penyesuaian_bonus, hasil_gaji,
        keterangan, keluar_masuk, created_at, updated_at
    )
    SELECT 
        bulan, periode, kode, nama, perusahaan, bagian, divisi,
        grade, grade_p1, grade_p2,
        h, b, i_b, i_tb, s_b, s_tb, t_b, t_tb, set_h, lp, tm, lembur,
        gapok, gaji_lembur, u_m, u_k, uang_bonus, kasbon, penyesuaian_bonus, hasil_gaji,
        keterangan, keluar_masuk, NOW(), NOW()
    FROM public.total_gaji_pabrik_garut
    WHERE bulan = p_bulan
      AND (perusahaan IS NULL OR UPPER(perusahaan) NOT LIKE '%BORONGAN%')
      AND (bagian IS NULL OR UPPER(bagian) NOT LIKE '%BORONGAN%')
      AND (divisi IS NULL OR UPPER(divisi) NOT LIKE '%BORONGAN%');

END;
$$ LANGUAGE plpgsql;

-- 3. Grant Access
GRANT ALL ON public.laporan_bulanan_pabrik_garut TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION sync_garut_laporan_bulanan TO anon, authenticated, service_role;

NOTIFY pgrst, 'reload config';
