-- Script Perbaikan Tabel Karyawan Pabrik
-- Jalankan script ini di SQL Editor Supabase Anda

-- 1. Buat tabel jika belum ada
CREATE TABLE IF NOT EXISTS public.karyawan_pabrik (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    kode TEXT,
    nama TEXT,
    jenis_kelamin TEXT DEFAULT 'L',
    grade_p1 TEXT,
    grade_p2 TEXT,
    divisi TEXT,
    bulan TEXT,
    keterangan TEXT,
    status_aktif BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Pastikan kolom-kolom yang diminta tersedia (Safe Update)
DO $$
BEGIN
    -- Tambah kolom 'kode' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='kode') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN kode TEXT;
    END IF;

    -- Tambah kolom 'nama' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='nama') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN nama TEXT;
    END IF;

    -- Tambah kolom 'jenis_kelamin' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='jenis_kelamin') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN jenis_kelamin TEXT DEFAULT 'L';
    END IF;

    -- Tambah kolom 'grade_p1' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='grade_p1') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN grade_p1 TEXT;
    END IF;

    -- Tambah kolom 'grade_p2' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='grade_p2') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN grade_p2 TEXT;
    END IF;

    -- Tambah kolom 'divisi' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='divisi') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN divisi TEXT;
    END IF;

    -- Tambah kolom 'bulan' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='bulan') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN bulan TEXT;
    END IF;

    -- Tambah kolom 'keterangan' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='keterangan') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN keterangan TEXT;
    END IF;
    
    -- Tambah kolom 'status_aktif' jika belum ada
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='karyawan_pabrik' AND column_name='status_aktif') THEN
        ALTER TABLE public.karyawan_pabrik ADD COLUMN status_aktif BOOLEAN DEFAULT true;
    END IF;
END $$;

-- 3. Perbaiki Izin Akses (RLS) agar aplikasi bisa membaca/menulis
ALTER TABLE public.karyawan_pabrik ENABLE ROW LEVEL SECURITY;

-- Hapus policy lama jika ada untuk menghindari konflik
DROP POLICY IF EXISTS "Public Access Karyawan" ON public.karyawan_pabrik;
DROP POLICY IF EXISTS "Enable read access for all users" ON public.karyawan_pabrik;
DROP POLICY IF EXISTS "Enable insert for all users" ON public.karyawan_pabrik;
DROP POLICY IF EXISTS "Enable update for all users" ON public.karyawan_pabrik;
DROP POLICY IF EXISTS "Enable delete for all users" ON public.karyawan_pabrik;

-- Buat policy baru yang mengizinkan semua akses (untuk kemudahan penggunaan awal)
CREATE POLICY "Public Access Karyawan" ON public.karyawan_pabrik FOR ALL USING (true) WITH CHECK (true);

-- Grant akses ke role anon dan authenticated
GRANT ALL ON public.karyawan_pabrik TO anon;
GRANT ALL ON public.karyawan_pabrik TO authenticated;
GRANT ALL ON public.karyawan_pabrik TO service_role;
